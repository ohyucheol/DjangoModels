<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
  
    <!-- **DO THIS**: -->
    <!--   Replace SDK_VERSION_NUMBER with the current SDK version number -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1194.0.min.js"></script>
    <script>
        // Amazon Cognito 인증 공급자를 초기화합니다
        AWS.config.region = 'ap-northeast-2'; // 리전
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
            IdentityPoolId: 'ap-northeast-2:d876053b-0c9e-48fb-b7cc-a4acf1615204',
        });

        var bucketName = 'testbucket.djangoapps';
        // var bucketRegion = 'ap-northeast-2';
        // var IdentityPoolId = 'ap-northeast-2:d876053b-0c9e-48fb-b7cc-a4acf1615204';

        var s3 = new AWS.S3({
          apiVersion: "2006-03-01",
          params: { Bucket: bucketName }
        });

    function viewPicture(photoKey) {
      s3.listObjects({ Prefix: '' }, function(err, data) {
        if (err) {
          return alert("There was an error listing your photo: ", err.message);
        }
        // 'this' references the AWS.Response instance that represents the response
        var href = this.request.httpRequest.endpoint.href;
        var bucketUrl = href + bucketName + "/";

        document.getElementById("hoho").src = bucketUrl + photoKey;
      });
    }

    function uploadPicture() {
      var files = document.getElementById("picture").files;
      if (!files.length) {
        return alert("Please choose a file to upload first.");
      }
      var file = files[0];
      var fileName = file.name;
      // var userKey = encodeURIComponent(username) + '/';

      var photoKey = fileName;
      // var photoKey = userKey + fileName; userkey로 폴더를 구분하는 경우

      // Use S3 ManagedUpload class as it supports multipart uploads
      var upload = new AWS.S3.ManagedUpload({
        params: {
          Bucket: bucketName,
          Key: photoKey,
          Body: file
        }
      });

      var promise = upload.promise();

      promise.then(
        function(data) {
          // alert("Successfully uploaded photo.");
          viewPicture(photoKey);
        },
        function(err) {
          return alert("There was an error uploading your photo: ", err.message);
        }
      );
    }
</script>
  </head>
  <body>
    <img id="hoho" src="#">
    <div class="input-group mb-3">
      <input type="file" class="form-control" id="picture">
      <button onclick="uploadPicture()" type="button" class="btn btn-primary">업로드</button>
    </div>
  </body>
</html>